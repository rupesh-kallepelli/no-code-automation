name: Building and Deploying slave

on:
  workflow_dispatch:
    inputs:
      service:
       description: "Select service to deploy"
       required: true
       type: choice
       options:
         - browser-service
         - test-runner-slave
  push:
    branches: [ main ]

jobs:
  get-pods:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin

      - name: cdp-protocol Build
        run: |
          echo "------------------------------------------------------------------------Building cdp-protocol------------------------------------------------------------------------"
          cd ./cdp-protocol
          ls -lrt
          chmod +x ./mvnw
          ./mvnw clean install
          cd ..
          echo "------------------------------------------------------------------------Build Successfully for cdp-protocol------------------------------------------------------------------------"

      - name: launcher-interface build
        run: |
          echo "------------------------------------------------------------------------Building launcher-interface------------------------------------------------------------------------"
          cd ./launcher-interface
          ls -lrt
          chmod +x ./mvnw
          ./mvnw clean install
          cd ..
          echo "------------------------------------------------------------------------Build Successfully for launcher-interface------------------------------------------------------------------------"

      - name: cdp-client build
        run: |
          echo "------------------------------------------------------------------------Building cdp-client------------------------------------------------------------------------"
          cd ./cdp-client
          ls -lrt
          chmod +x ./mvnw
          ./mvnw clean install
          cd ..
          echo "------------------------------------------------------------------------Build Successfully for cdp-client-------------------------------------------------------------------------"

      - name: chrome-cdp-actions Build
        run: |
          echo "------------------------------------------------------------------------Building chrome-cdp-actions------------------------------------------------------------------------"
          cd ./chrome-cdp-actions
          ls -lrt
          chmod +x ./mvnw
          ./mvnw clean install
          cd ..
          echo " ------------------------------------------------------------------------Build Successfully for chrome-cdp-actions ------------------------------------------------------------------------"

      - name: Build ${{ github.event.inputs.service }}
        run: |
          echo "------------------------------------------------------------------------Building browser-service------------------------------------------------------------------------"
          cd ./${{ github.event.inputs.service }}
          chmod +x ./mvnw
          ./mvnw clean install -DskipTests

          echo "Files in target:"
          ls -lrt target/

          # Pick the first main jar and move it
          MAIN_JAR=$(find target -maxdepth 1 -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -n 1)
          echo "Using JAR: $MAIN_JAR"
          mv "$MAIN_JAR" ./app.jar

          echo "Files in workspace:"
          ls -lrt

          cd ..
          echo "------------------------------------------------------------------------Build Successfully for browser-service------------------------------------------------------------------------"
      - name: Install OpenShift CLI
        uses: redhat-actions/oc-installer@v1

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify

      - name: Build ${{ github.event.inputs.service }}
        run: |
          oc start-build ${{ github.event.inputs.service }} --from-file=./${{ github.event.inputs.service }}/app.jar --follow
