###########################################
# Prometheus ConfigMap
###########################################
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: {{ .Values.namespace }}
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      scrape_timeout: 10s

    scrape_configs:
      # 1️⃣ Scrape browser-service pods JVM metrics
      - job_name: 'browser-service-pods'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - {{ .Values.namespace }}
        relabel_configs:
          # Keep only pods with label app=browser-service
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: browser-service
            action: keep
          # Set __address__ to pod IP:8080
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: __address__
            replacement: ${1}:8080
          # Force correct path
          - target_label: __metrics_path__
            replacement: /actuator/prometheus

      # 2️⃣ Scrape container metrics via kubelet/cAdvisor
      - job_name: 'kubernetes-cadvisor'
        kubernetes_sd_configs:
          - role: node
        scheme: https
        metrics_path: /metrics/cadvisor
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          # Only scrape containers in your namespace
          - source_labels: [__meta_kubernetes_node_label_kubernetes_io_hostname]
            regex: .*
            action: keep
