# =========================================
# 1) ImageStream for the CfT-based Chrome image
# =========================================
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  name: jdk17-chrome
---
# =========================================
# 2) BuildConfig: CfT Chrome on UBI OpenJDK 17 (OpenShift-UID-safe)
# =========================================
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: jdk17-chrome
spec:
  source:
    type: Dockerfile
    dockerfile: |
      FROM registry.access.redhat.com/ubi8/openjdk-17:1.17-1
      USER 0
      
      # Runtime deps for Chrome on UBI/RHEL
      RUN microdnf install -y unzip curl ca-certificates \
          atk gtk3 libX11 libXcomposite libXcursor libXdamage libXext libXfixes \
          libXi libXrandr libXrender nss nspr alsa-lib cups-libs libdrm \
          mesa-libgbm pango glib2 xorg-x11-fonts-Type1 xorg-x11-fonts-misc wget \
      && microdnf clean all
      
      # Chrome for Testing (stable, version pinned)
      # CfT is meant for automation; versioned and CI-friendly.
      # Docs: https://developer.chrome.com/blog/chrome-for-testing/
      ENV CFT_VER=143.0.7499.192
      RUN curl -L "https://storage.googleapis.com/chrome-for-testing-public/${CFT_VER}/linux64/chrome-linux64.zip" -o /tmp/chrome.zip \
      && unzip /tmp/chrome.zip -d /opt/chrome \
      && rm -f /tmp/chrome.zip
      
      # OpenShift arbitrary UID pattern (group 0 + g=u)
      RUN mkdir -p /app /tmp/chrome /home/default \
      && chgrp -R 0 /opt/chrome /app /tmp /home/default /etc/passwd /etc/group \
      && chmod -R g=u /opt/chrome /app /tmp /home/default /etc/passwd /etc/group
      
      ENV PATH="/opt/chrome/chrome-linux64:${PATH}" \
      HOME=/home/default \
      TMPDIR=/tmp
      
      WORKDIR /app
# Do not set USER; OpenShift injects a random UID at runtime.
strategy:
  type: Docker
output:
  to:
    kind: ImageStreamTag
    name: jdk17-chrome:latest
---
# =========================================
# 3) ConfigMap: nginx reverse proxy (listens 9223 -> proxies to Chrome 127.0.0.1:9222)
# =========================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: browser-service-nginx-conf
data:
  nginx.conf: |
    worker_processes  1;

    events { 
        worker_connections 1024; 
    }

    http {
        lua_shared_dict session_dict 10m;

        init_worker_by_lua_block {
            local http = require "resty.http"

            local function update_sessions(premature)
                if premature then return end

                local httpc = http.new()
                local res, err = httpc:request_uri("http://127.0.0.1:8080/api/v1/sessions", {
                    method = "GET",
                    ssl_verify = false
                })

                if res and res.status == 200 then
                    local cjson = require "cjson.safe"
                    local sessions, err = cjson.decode(res.body)
                    if sessions then
                        local dict = ngx.shared.session_dict
                        dict:flush_all()
                        for sessionId, backend in pairs(sessions) do
                            dict:set(sessionId, backend)
                        end
                    else
                        ngx.log(ngx.ERR, "Failed to decode session JSON: ", err)
                    end
                else
                    ngx.log(ngx.ERR, "Failed to fetch sessions: ", err or res.status)
                end

                -- Schedule next update in 5 seconds
                local ok, err = ngx.timer.at(5, update_sessions)
                if not ok then
                    ngx.log(ngx.ERR, "Failed to schedule timer: ", err)
                end
            end

            -- First run
            local ok, err = ngx.timer.at(0, update_sessions)
            if not ok then
                ngx.log(ngx.ERR, "Failed to start session update timer: ", err)
            end
        }

        map $http_upgrade $connection_upgrade {
            default upgrade;
            '' close;
        }

        server {
            listen 9223;

            location = /healthz {
                return 200 'ok';
                add_header Content-Type text/plain;
            }
           set $chrome_backend "";
            location /session/ {
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_set_header Host localhost;

                access_by_lua_block {
                    local uri = ngx.var.uri
                    local session_id = uri:match("/session/([^/]+)/")
                    if not session_id then
                        ngx.status = 404
                        ngx.say("session not found")
                        return ngx.exit(404)
                    end

                    local dict = ngx.shared.session_dict
                    local backend = dict:get(session_id)
                    if not backend then
                        ngx.status = 404
                        ngx.say("session inactive")
                        return ngx.exit(404)
                    end

                    ngx.var.chrome_backend = backend
                }

                proxy_pass http://$chrome_backend;
            }
        }
    }

---
# =========================================
# 4) Deployment: Chrome (headless new) + nginx proxy sidecar
#    - Chrome binds to 127.0.0.1:9222 (new headless restriction)
#    - nginx exposes 9223 and proxies to 127.0.0.1:9222
# =========================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: browser-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: browser-service
  template:
    metadata:
      labels:
        app: browser-service
    spec:
      securityContext:
        runAsNonRoot: true
      containers:
        - name: browser-service
          image: 'image-registry.openshift-image-registry.svc:5000/kallepallirupesh-dev/browser-service:latest'
          ports:
            - containerPort: 9999
            - containerPort: 9222
          securityContext:
            runAsNonRoot: false
            allowPrivilegeEscalation: false
            capabilities:
              add:
                - NET_BIND_SERVICE
          volumeMounts:
            - name: dshm
              mountPath: /dev/shm
            - name: chrome-data
              mountPath: /tmp/chrome
        - name: nginx
          image: your-custom-openresty-image:latest
          command:
            - "/usr/local/openresty/bin/openresty"
          args:
            - "-g"
            - "daemon off;"
            - "-c"
            - "/usr/local/openresty/nginx/conf/nginx.conf"
          ports:
            - containerPort: 9223
          securityContext:
            runAsNonRoot: true
          volumeMounts:
            - name: nginx-conf
              mountPath: /usr/local/openresty/nginx/conf/nginx.conf
              subPath: nginx.conf
          readinessProbe:
            httpGet:
              path: /healthz
              port: 9223
            initialDelaySeconds: 2
            periodSeconds: 4
          livenessProbe:
            httpGet:
              path: /healthz
              port: 9223
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 1Gi
        - name: chrome-data
          emptyDir: { }
        - name: nginx-conf
          configMap:
            name: browser-service-nginx-conf
            items:
              - key: nginx.conf
                path: nginx.conf
---
# =========================================
# 5) Service + Route to expose nginx externally on 9223
# =========================================
apiVersion: v1
kind: Service
metadata:
  name: browser-service
spec:
  selector:
    app: browser-service
  ports:
    - name: cdp
      port: 9223
      targetPort: 9223
      protocol: TCP
    - name: http
      port: 9999
      targetPort: 9999
      protocol: TCP
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: browser-service
spec:
  to:
    kind: Service
    name: browser-service
  port:
    targetPort: http
  tls:
    termination: edge
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: browser-service-cdp
spec:
  to:
    kind: Service
    name: browser-service
  port:
    targetPort: cdp
  tls:
    termination: edge
---