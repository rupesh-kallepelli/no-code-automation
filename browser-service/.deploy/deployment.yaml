apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: jdk17-chrome
spec:
  source:
    type: Dockerfile
    dockerfile: |
      FROM registry.access.redhat.com/ubi8/openjdk-17:1.17-1

      USER 0

      # Install dependencies
      RUN microdnf install -y \
            unzip curl atk gtk3 libX11 libXcomposite libXcursor libXdamage libXext libXfixes \
            libXi libXrandr libXrender nss nspr alsa-lib cups-libs libdrm mesa-libgbm pango glib2 \
            xorg-x11-fonts-Type1 xorg-x11-fonts-misc \
            && microdnf clean all

      # Download Chrome-for-Testing
      RUN curl -L https://storage.googleapis.com/chrome-for-testing-public/143.0.7499.192/linux64/chrome-linux64.zip \
          -o /tmp/chrome.zip \
          && unzip /tmp/chrome.zip -d /opt/chrome \
          && rm -f /tmp/chrome.zip

      # Permissions for OpenShift non-root UID
      RUN chmod -R 755 /opt/chrome \
          && mkdir -p /app /tmp/chrome /home/chromeuser \
          && chmod -R g+rwX /app /tmp /home/chromeuser \
          && chown -R 1000:0 /opt/chrome /app /tmp /home/chromeuser

      # Add chrome to PATH
      ENV PATH="/opt/chrome/chrome-linux64:${PATH}"
      ENV HOME=/home/chromeuser
      ENV TMPDIR=/tmp
      ENV CHROME_USER_DATA_DIR=/tmp/chrome

      WORKDIR /app

      USER 1000

      CMD ["bash"]
strategy:
  type: Docker
output:
  to:
    kind: ImageStreamTag
    name: jdk17-chrome:latest
---
# =========================================
# 3) ConfigMap: nginx reverse proxy (listens 9223 -> proxies to Chrome 127.0.0.1:xxxx)
# =========================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: browser-service-nginx-conf
data:
  nginx.conf: |
    error_log /dev/stderr info;
    pid /tmp/nginx.pid;

    worker_processes 1;

    events {
        worker_connections 1024;
    }

    http {

        # ---------------------------------------
        # WebSocket upgrade handling
        # ---------------------------------------
        map $http_upgrade $connection_upgrade {
            default upgrade;
            ''      close;
        }

        server {
            listen 9223;

            # ---------------------------------------
            # Health check
            # ---------------------------------------
            location = /healthz {
                return 200 'ok';
                add_header Content-Type text/plain;
            }

            # =====================================================
            # CDP PROXY (PORT ONLY)
            #
            # URL FORMAT:
            #   /proxy/<port>/...
            #
            # EXAMPLES:
            #   /proxy/41273/json
            #   /proxy/41273/devtools/page/XXXX
            #
            # =====================================================
            location ~ ^/proxy/([0-9]+)(/.*)$ {

                set $target_port $1;
                set $forward_path $2;

                # ---------------------------------------
                # Proxy to local Chrome instance
                # ---------------------------------------
                proxy_pass http://127.0.0.1:$target_port$forward_path;

                proxy_http_version 1.1;

                # ðŸ”‘ Chrome requires this Host header
                proxy_set_header Host 127.0.0.1;

                # WebSocket headers
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "Upgrade";

                # Forwarding headers
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                # REQUIRED for CDP
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
            }
        }
    }

---
# =========================================
# 4) Deployment: Chrome (headless new) + nginx proxy sidecar
#    - Chrome binds to 127.0.0.1:9222 (new headless restriction)
#    - nginx exposes 9223 and proxies to 127.0.0.1:9222
# =========================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: browser-service
  namespace: kallepallirupesh-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: browser-service
  template:
    metadata:
      labels:
        app: browser-service
    spec:
      # Pod-level securityContext (fsGroup applies to all containers)
      securityContext:
        runAsNonRoot: true
      containers:
        - name: browser-service
          image: 'image-registry.openshift-image-registry.svc:5000/kallepallirupesh-dev/browser-service:latest'
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          ports:
            - containerPort: 9999
            - containerPort: 9222
          securityContext:
            runAsNonRoot: false
            allowPrivilegeEscalation: false
            capabilities:
              add:
                - NET_BIND_SERVICE
          volumeMounts:
            - name: dshm
              mountPath: /dev/shm
            - name: chrome-data
              mountPath: /tmp/chrome
        - name: nginx
          image: 'registry.access.redhat.com/ubi9/nginx-120'
          command: [ "nginx" ]
          args: [ "-g","daemon off;" ]
          ports:
            - containerPort: 9223
          securityContext:
            runAsNonRoot: true
          volumeMounts:
            - name: nginx-conf
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
          readinessProbe:
            httpGet:
              path: /healthz
              port: 9223
            initialDelaySeconds: 2
            periodSeconds: 4
          livenessProbe:
            httpGet:
              path: /healthz
              port: 9223
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 1Gi
        - name: chrome-data
          emptyDir: { }
        - name: nginx-conf
          configMap:
            name: browser-service-nginx-conf
            items:
              - key: nginx.conf
                path: nginx.conf

---
# =========================================
# 5) Service + Route to expose nginx externally on 9223
# =========================================
apiVersion: v1
kind: Service
metadata:
  name: browser-service
spec:
  selector:
    app: browser-service
  ports:
    - name: cdp
      port: 9223
      targetPort: 9223
      protocol: TCP
    - name: http
      port: 9999
      targetPort: 9999
      protocol: TCP
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: browser-service
spec:
  to:
    kind: Service
    name: browser-service
  port:
    targetPort: http
  tls:
    termination: edge
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: browser-service-cdp
spec:
  to:
    kind: Service
    name: browser-service
  port:
    targetPort: cdp
  tls:
    termination: edge
---